<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Contaminant Analyzer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .image-container {
            border: 2px dashed #ccc;
            padding: 10px;
            text-align: center;
        }

        .cropper-container {
            max-width: 100%;
            height: 300px;
        }

        .button-group {
            margin: 20px 0;
            text-align: center;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #4CAF50;
            color: white;
        }

        .concentration-input {
            margin: 20px 0;
            text-align: center;
        }

        .concentration-input label {
            margin-right: 10px;
            font-weight: bold;
        }

        .concentration-input input {
            padding: 8px;
            width: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Milk Contaminant Analyzer</h1>
        
        <div class="upload-section">
            <div class="image-container">
                <h3>Sample Image</h3>
                <input type="file" id="sampleInput" accept="image/*">
                <div class="cropper-container">
                    <img id="sampleImage" class="cropper">
                </div>
            </div>

            <div class="image-container">
                <h3>Reference Image</h3>
                <input type="file" id="referenceInput" accept="image/*">
                <div class="cropper-container">
                    <img id="referenceImage" class="cropper">
                </div>
            </div>
        </div>

        <div class="concentration-input">
            <label for="concentration">Concentration (%w/v):</label>
            <input type="number" id="concentration" min="0" step="0.1" placeholder="Enter concentration">
        </div>

        <div class="button-group">
            <button id="processBtn" onclick="processImages()" disabled>Process Images</button>
            <button onclick="exportCSV()">Export to CSV</button>
        </div>

        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Concentration (%w/v)</th>
                    <th>Sample RGB</th>
                    <th>Reference RGB</th>
                    <th>Relative RGB</th>
                    <th>Relative Hue</th>
                </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        let sampleCropper, referenceCropper;
        let results = [];

        function initializeCropper(imageElement, inputElement) {
            inputElement.addEventListener('change', function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    imageElement.src = event.target.result;
                    if (imageElement.cropper) {
                        imageElement.cropper.destroy();
                    }
                    imageElement.cropper = new Cropper(imageElement, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 1
                    });
                    checkReadyToProcess();
                }
                reader.readAsDataURL(file);
            });
        }

        function checkReadyToProcess() {
            const sampleReady = document.getElementById('sampleImage').cropper !== undefined;
            const referenceReady = document.getElementById('referenceImage').cropper !== undefined;
            const concentration = document.getElementById('concentration').value;
            
            document.getElementById('processBtn').disabled = !(sampleReady && referenceReady && concentration);
        }

        function getAverageRGB(imageElement) {
            const canvas = imageElement.cropper.getCroppedCanvas();
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let r = 0, g = 0, b = 0;

            for (let i = 0; i < data.length; i += 4) {
                r += data[i];
                g += data[i + 1];
                b += data[i + 2];
            }

            const total = data.length / 4;
            return {
                r: Math.round(r / total),
                g: Math.round(g / total),
                b: Math.round(b / total)
            };
        }

        function rgbToHue(r, g, b) {
            // Normalize RGB values to 0-1 range
            const rPrime = r / 255;
            const gPrime = g / 255;
            const bPrime = b / 255;

            const cmax = Math.max(rPrime, gPrime, bPrime);
            const cmin = Math.min(rPrime, gPrime, bPrime);
            const delta = cmax - cmin;

            if (delta === 0) {
                return 0;
            }

            let hue;
            if (cmax === rPrime) {
                hue = 60 * (((gPrime - bPrime) / delta) % 6);
            } else if (cmax === gPrime) {
                hue = 60 * (((bPrime - rPrime) / delta) + 2);
            } else {
                hue = 60 * (((rPrime - gPrime) / delta) + 4);
            }

            return Math.round((hue < 0 ? hue + 360 : hue) % 360);
        }

        function processImages() {
            const sampleRGB = getAverageRGB(document.getElementById('sampleImage'));
            const referenceRGB = getAverageRGB(document.getElementById('referenceImage'));
            const concentration = document.getElementById('concentration').value;

            const relativeRGB = {
                r: referenceRGB.r - sampleRGB.r,
                g: referenceRGB.g - sampleRGB.g,
                b: referenceRGB.b - sampleRGB.b
            };

            const relativeHue = rgbToHue(relativeRGB.r, relativeRGB.g, relativeRGB.b);

            results.push({
                concentration,
                sampleRGB,
                referenceRGB,
                relativeRGB,
                relativeHue
            });

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${concentration}</td>
                <td>(${sampleRGB.r}, ${sampleRGB.g}, ${sampleRGB.b})</td>
                <td>(${referenceRGB.r}, ${referenceRGB.g}, ${referenceRGB.b})</td>
                <td>(${relativeRGB.r}, ${relativeRGB.g}, ${relativeRGB.b})</td>
                <td>${relativeHue}Â°</td>
            `;
            document.getElementById('resultsBody').appendChild(row);

            document.getElementById('concentration').value = '';
            document.getElementById('processBtn').disabled = true;
        }

        function exportCSV() {
            if (results.length === 0) return;

            const csvContent = [
                'Concentration (%w/v),Sample R,Sample G,Sample B,Reference R,Reference G,Reference B,Relative R,Relative G,Relative B,Relative Hue',
                ...results.map(r => 
                    `${r.concentration},` +
                    `${r.sampleRGB.r},${r.sampleRGB.g},${r.sampleRGB.b},` +
                    `${r.referenceRGB.r},${r.referenceRGB.g},${r.referenceRGB.b},` +
                    `${r.relativeRGB.r},${r.relativeRGB.g},${r.relativeRGB.b},` +
                    `${r.relativeHue}`
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, 'analysis_results.csv');
        }

        window.addEventListener('DOMContentLoaded', () => {
            initializeCropper(
                document.getElementById('sampleImage'),
                document.getElementById('sampleInput')
            );
            initializeCropper(
                document.getElementById('referenceImage'),
                document.getElementById('referenceInput')
            );
            document.getElementById('concentration').addEventListener('input', checkReadyToProcess);
        });
    </script>
</body>
</html>